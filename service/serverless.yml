---

frameworkVersion: 1.34.1

service: sanity

provider:
  name: aws
  region: us-east-1
  stage: dev
  tag: default
  iamRoleStatements:
    - Effect: Allow
      Action:
        - s3:GetObject
        - s3:PutObject
      Resource:
        - "arn:aws:s3:::${self:custom.s3_bucket}/*"
    - Effect: Allow
      Action: 
        - secretsmanager:GetResourcePolicy
        - secretsmanager:GetSecretValue
        - secretsmanager:DescribeSecret
        - secretsmanager:ListSecretVersionIds
      Resource: 
        - "arn:aws:secretsmanager:${self:custom.region}:${self:custom.accountId}:secret:sanity_runner/*"

  environment:
    SLS_STAGE: ${self:custom.stage}
    S3_BUCKET: ${self:custom.s3_bucket}
    CHROME_BUCKET: ${self:custom.s3_bucket}/chrome
    SCREENSHOT_BUCKET: ${self:custom.s3_bucket}/screenshots


custom:
  region: ${env:SERVERLESS_REGION, self:provider.region}
  stage: ${env:SERVERLESS_STAGE, self:provider.stage}
  tag: ${env:SERVERLESS_TAG, self:provider.tag}
  accountId: ${env:SERVERLESS_ACCOUNTID, self:provider.tag}
  s3_bucket: sr-${self:custom.stage}-${self:custom.tag}
  functon_name: sanity-runner-${self:custom.stage}-${self:custom.tag}

package:
  exclude:
    - chrome/**
    - test/**
    - Makefile
    - yarn.lock

functions:
  sanityLauncher:
    runtime: nodejs8.10
    memorySize: 2048
    timeout: 90
    handler: src/lambdaHandler.handler
    name: ${env:SERVERLESS_FUNC, self:custom.functon_name}

resources:
  Resources:
    THMChromeImages:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: ${self:custom.s3_bucket}